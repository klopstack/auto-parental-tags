name: "CI Build, Lint, and Coverage"

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          cache: true
          cache-dependency-path: '**/packages.lock.json'

      - name: Restore
        run: dotnet restore Jellyfin.Plugin.AutoParentalTags.sln --locked-mode

      - name: Install dotnet-format
        run: |
          dotnet tool install -g dotnet-format
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Lint (dotnet-format)
        run: dotnet format Jellyfin.Plugin.AutoParentalTags.sln --verify-no-changes

      - name: Build (Debug)
        run: dotnet build Jellyfin.Plugin.AutoParentalTags.sln --configuration Debug --no-restore

      - name: Extract Coverage Threshold
        id: threshold
        run: |
          THRESHOLD=$(grep -oP '<Threshold>\K[0-9]+' Jellyfin.Plugin.AutoParentalTags.Tests/Jellyfin.Plugin.AutoParentalTags.Tests.csproj)
          echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
          echo "Coverage threshold from .csproj: ${THRESHOLD}%"

      - name: Test with Coverage (Coverlet)
        run: |
          dotnet test Jellyfin.Plugin.AutoParentalTags.Tests/Jellyfin.Plugin.AutoParentalTags.Tests.csproj \
            --configuration Debug \
            /p:CollectCoverage=true \
            /p:CoverletOutput=../TestResults/coverage.info \
            /p:CoverletOutputFormat=lcov

      - name: Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: TestResults/coverage.info
          if-no-files-found: error

      - name: Verify Coverage Meets Threshold
        run: |
          THRESHOLD=${{ steps.threshold.outputs.threshold }}
          percent=$(awk -F, '/^DA:/{total++; if($2>0) covered++} END{printf "%.2f", (covered/total)*100}' TestResults/coverage.info)
          echo "Line coverage: ${percent}%"
          echo "Required threshold: ${THRESHOLD}%"
          awk -v p="$percent" -v t="$THRESHOLD" 'BEGIN{exit p<t}'
